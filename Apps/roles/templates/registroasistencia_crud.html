{% load static %}
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>CRUD Registro de Asistencia</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    {{ colaborador_info|json_script:"colaboradorInfo" }}
    {% if messages %}
  <div>
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">
        {{ message }}
      </div>
    {% endfor %}
  </div>
{% endif %}
    <div class="container mt-4">
      <h1>Registros de Asistencia</h1>
      <button
        class="btn btn-primary"
        data-bs-toggle="modal"
        data-bs-target="#createAsistenciaModal"
      >
        Crear Registro de Asistencia
      </button>

      <table class="table table-striped mt-3">
        <thead>
          <tr>
            <th>Colaborador</th>
            <th>Codigo</th>
            <th>Sucursal</th>
            <th>Rol</th>
            <th>Fecha</th>
            <th>Hora Entrada</th>
            <th>Hora Salida</th>
            <th>Cumplimiento</th>
            <th>Total Horas</th>
            <th>Justificado</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for reg in registros %}
          <tr>
            <td>{{ reg.colaborador.nombrecolaborador }}</td>
            <td>{{ reg.colaborador.codigocolaborador }}</td>
            <td>{{ reg.sucursal.nombre_sucursal }}</td>
            <td>
              {% if reg.rol %}
                {{ reg.rol.nombre }}
              {% else %}
                <span class="text-danger">
                  Sin Rol (Fuera de rango)
                </span>
              {% endif %}
            </td>
            <td>{{ reg.fecha }}</td>
            <td>{{ reg.hora_entrada }}</td>
            <td>{{ reg.hora_salida }}</td>
            {% comment %} <td>{{ reg.cumplimiento }}</td> {% endcomment %}

            <td>
              {% if reg.cumplimiento == "NO_CUMPLIO" %}
                <span class="badge text-bg-danger">No Cumplió</span>
              {% elif reg.cumplimiento == "<" or reg.cumplimiento == ">" or reg.cumplimiento == "=" %}
                <span class="badge text-bg-success">Cumplió {{ reg.cumplimiento }}</span>
              {% else %}
                {{ reg.cumplimiento }}
              {% endif %}
            </td>

            <td>{{ reg.total_horas }}</td>
            <td>{{ reg.justificado }}</td>
            <td>{{ reg.estado }}</td>
            <td>
              <button
                class="btn btn-warning btn-sm"
                data-bs-toggle="modal"
                data-bs-target="#updateAsistenciaModal{{ reg.id }}"
              >
                Editar
              </button>

              <button
                class="btn btn-danger btn-sm"
                data-bs-toggle="modal"
                data-bs-target="#inactivateAsistenciaModal{{ reg.id }}"
              >
                Inactivar
              </button>
            </td>
          </tr>

          <!-- Modal Editar -->
<div class="modal fade" id="updateAsistenciaModal{{ reg.id }}" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
      <form method="POST" action="{% url 'registroasistencia_update' reg.id %}">
          {% csrf_token %}
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title">Editar Registro de Asistencia</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
              </div>
              <div class="modal-body">
                  <!-- Colaborador -->
                  <div class="mb-3">
                      <label class="form-label">Colaborador</label>
                      <select name="colaborador" class="form-select colaborador-select">
                          {% for colaborador in colaboradores %}
                          <option value="{{ colaborador.id }}" {% if reg.colaborador.id == colaborador.id %}selected{% endif %}>
                              {{ colaborador.codigocolaborador }} - {{ colaborador.nombrecolaborador }}
                          </option>
                          {% endfor %}
                      </select>
                  </div>

                  <!-- Sucursal (autollenado) -->
                  <div class="mb-3">
                      <label class="form-label">Sucursal</label>
                      <input type="text" class="form-control sucursal-nombre" value="{{ reg.sucursal.nombresucursal }}" readonly />
                      <input type="hidden" name="sucursal" class="sucursal-id" value="{{ reg.sucursal.id }}" />
                  </div>

                  <!-- Rol (autollenado) -->
                  <div class="mb-3">
                      <label class="form-label">Rol</label>
                      <input type="text" class="form-control rol-nombre" value="{% if reg.rol %}{{ reg.rol.nombre }} | 
                      {{ reg.rol.rol_horario_semana }} | 
                       {{ reg.rol.rol_horario_sabado }} | 
                        {{ rol_horario_domingo }} {% else %}N/A{% endif %}" readonly />
                      <input type="hidden" name="rol" class="rol-id" value="{{ reg.rol.id }}" />
                  </div>

                  <!-- Fecha -->
                  <div class="mb-3">
                    <label class="form-label">Fecha</label>
                    <!-- Campo date: usamos |date:'Y-m-d' -->
                    <input type="date" name="fecha" class="form-control"
                           value="{{ reg.fecha|default_if_none:''|date:'Y-m-d' }}">
                  </div>

                  <!-- Hora Entrada -->
                  <div class="mb-3">
                      <label class="form-label">Hora Entrada</label>
                      <input type="time" name="hora_entrada" class="form-control" value="{{ reg.hora_entrada }}" />
                  </div>

                  <!-- Hora Salida -->
                  <div class="mb-3">
                      <label class="form-label">Hora Salida</label>
                      <input type="time" name="hora_salida" class="form-control" value="{{ reg.hora_salida }}" />
                  </div>
              </div>
              <div class="modal-footer">
                  <button type="submit" class="btn btn-primary">Guardar</button>
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              </div>
          </div>
      </form>
  </div>
</div>


          <!-- Modal Inactivar -->
          <div
            class="modal fade"
            id="inactivateAsistenciaModal{{ reg.id }}"
            tabindex="-1"
            aria-hidden="true"
          >
            <div class="modal-dialog">
              <form
                method="POST"
                action="{% url 'registroasistencia_inactivate' reg.id %}"
              >
                {% csrf_token %}
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">
                      Inactivar Registro de Asistencia
                    </h5>
                    <button
                      type="button"
                      class="btn-close"
                      data-bs-dismiss="modal"
                      aria-label="Cerrar"
                    ></button>
                  </div>
                  <div class="modal-body">
                    <p>
                      ¿Seguro que deseas inactivar este registro de asistencia?
                    </p>
                  </div>
                  <div class="modal-footer">
                    <button type="submit" class="btn btn-danger">
                      Inactivar
                    </button>
                    <button
                      type="button"
                      class="btn btn-secondary"
                      data-bs-dismiss="modal"
                    >
                      Cancelar
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>

          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Modal Crear -->
<div class="modal fade" id="createAsistenciaModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
      <form method="POST" action="{% url 'registroasistencia_create' %}">
          {% csrf_token %}
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title">Crear Registro de Asistencia</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
              </div>

              <div class="modal-body">
                  <!-- Colaborador -->
                  <div class="mb-3">
                      <label class="form-label">Colaborador</label>
                      <select name="colaborador" class="form-select colaborador-select">
                          {% for colaborador in colaboradores %}
                          <option value="{{ colaborador.id }}">
                              {{ colaborador.codigocolaborador }} - {{ colaborador.nombrecolaborador }}
                          </option>
                          {% endfor %}
                      </select>
                  </div>

                  <!-- Sucursal (autollenado) -->
                  <div class="mb-3">
                      <label class="form-label">Sucursal</label>
                      <input type="text" class="form-control sucursal-nombre" readonly />
                      <input type="hidden" name="sucursal" class="sucursal-id" />
                  </div>

                  <!-- Rol (autollenado) -->
                  <div class="mb-3">
                      <label class="form-label">Rol</label>
                      <input type="text" class="form-control rol-nombre" readonly />
                      <input type="hidden" name="rol" class="rol-id" />
                  </div>

                  <!-- Fecha -->
                  <div class="mb-3">
                      <label class="form-label">Fecha</label>
                      <input type="date" name="fecha" class="form-control" required />
                  </div>

                  <!-- Hora Entrada -->
                  <div class="mb-3">
                      <label class="form-label">Hora Entrada</label>
                      <input type="time" name="hora_entrada" class="form-control" />
                  </div>

                  <!-- Hora Salida -->
                  <div class="mb-3">
                      <label class="form-label">Hora Salida</label>
                      <input type="time" name="hora_salida" class="form-control" />
                  </div>
              </div>

              <div class="modal-footer">
                  <button type="submit" class="btn btn-primary">Crear</button>
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
              </div>
          </div>
      </form>
  </div>
</div>

    <script>
      document.addEventListener("DOMContentLoaded", function() {
          const colaboradorSelects = document.querySelectorAll(".colaborador-select");
  
          // Verificar si se encuentra el JSON generado en el template
          const colaboradorInfoElement = document.getElementById("colaboradorInfo");
         
          let colaboradorInfo = {};
  
          if (colaboradorInfoElement) {
              colaboradorInfo = JSON.parse(colaboradorInfoElement.textContent);
              //console.log("Colaborador Info cargado:", colaboradorInfo);
          } else {
              console.error("No se encontró el JSON de colaborador_info");
          }
  
          // Función para actualizar datos de sucursal y rol según el colaborador seleccionado
          function actualizarDatosColaborador(selectElement) {
              const colabId = parseInt(selectElement.value);
              const modal = selectElement.closest(".modal"); // Identificar la modal actual
              const inputSucursalID = modal.querySelector(".sucursal-id");
              const inputSucursalNombre = modal.querySelector(".sucursal-nombre");
              const inputRolID = modal.querySelector(".rol-id");
              const inputRolNombre = modal.querySelector(".rol-nombre");
  
              if (colaboradorInfo[colabId]) {
                  inputSucursalID.value = colaboradorInfo[colabId].sucursal_id;
                  inputSucursalNombre.value = colaboradorInfo[colabId].sucursal_nombre;
                  inputRolID.value = colaboradorInfo[colabId].rol_id;
                  inputRolNombre.value = `${colaboradorInfo[colabId].rol_nombre} | ${colaboradorInfo[colabId].rol_horario_semana} | ${colaboradorInfo[colabId].rol_horario_sabado} | ${colaboradorInfo[colabId].rol_horario_domingo}`;
              } else {
                  inputSucursalID.value = "";
                  inputSucursalNombre.value = "";
                  inputRolID.value = "";
                  inputRolNombre.value = "";
              }
          }
  
          // Asignar evento `change` a cada selector de colaborador
          colaboradorSelects.forEach(select => {
              select.addEventListener("change", function () {
                  actualizarDatosColaborador(this);
                  //console.log("Colaborador Info Element:", colaboradorInfoElement);
              });
  
              // Disparar el evento `change` por defecto para que se cargue el primer valor
              actualizarDatosColaborador(select);
          });
  
          // Detectar cuando se abre una modal y actualizar los datos
          document.querySelectorAll(".modal").forEach(modal => {
              modal.addEventListener("shown.bs.modal", function () {
                  const select = modal.querySelector(".colaborador-select");
                  if (select) {
                      actualizarDatosColaborador(select);
                  }
              });
          });
      });
    </script>
  

    <script>
      //console.log("colaboradorInfo:", colaboradorInfo);
      //console.log(document.getElementById("colaboradorInfo").textContent);
      //console.log(colaboradorInfo);
    </script>

    <script src=" 	https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
